<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRIES-SCAN Pro+ | USDA Official Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .canvas-container { width: 100%; height: 320px; overflow: hidden; border-radius: 1.5rem; position: relative; background: #0f172a; display: flex; align-items: center; justify-content: center; border: 1px solid #334155; }
        canvas, video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .report-card { background: white; color: #0f172a; border-radius: 2rem; padding: 2rem; border: 4px solid #f59e0b; font-family: sans-serif; }
        .editable-field { border-bottom: 2px dashed #cbd5e1; padding: 2px 5px; min-width: 120px; display: inline-block; outline: none; font-weight: 800; color: #1e293b; }
        .editable-field:focus { border-bottom-color: #f59e0b; background: #fffbeb; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-slate-950 min-h-screen text-slate-200 p-4">

    <div class="max-w-[1000px] mx-auto">
        <header class="no-print mb-6 flex items-center justify-between bg-slate-900/50 p-4 rounded-3xl border border-slate-800">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üçü</span>
                <h1 class="text-lg font-black text-white uppercase tracking-tighter">FRIES-SCAN <span class="text-amber-500">PRO</span></h1>
            </div>
            <div class="flex gap-2">
                <button id="startVideo" class="px-5 py-3 bg-amber-500 text-slate-950 font-black text-[10px] uppercase rounded-2xl shadow-lg active:scale-95 transition-transform">Live Camera</button>
                <button id="captureSnapshot" class="hidden px-5 py-3 bg-white text-slate-950 font-black text-[10px] uppercase rounded-2xl shadow-xl active:scale-95 transition-transform">Analizza Ora</button>
            </div>
        </header>

        <main>
            <div id="workArea" class="grid grid-cols-1 md:grid-cols-2 gap-4 no-print mb-8">
                <div class="canvas-container"><video id="videoFeed" autoplay playsinline class="hidden w-full h-full"></video><canvas id="sourceCanvas"></canvas></div>
                <div class="canvas-container ring-2 ring-amber-500/20"><canvas id="processedCanvas"></canvas></div>
            </div>

            <div id="finalReport" class="hidden report-card shadow-2xl">
                <div class="flex justify-between items-center border-b-2 border-slate-100 pb-6 mb-6">
                    <div>
                        <h2 class="text-2xl font-black tracking-tighter uppercase text-slate-900">Report Ispezione Qualit√†</h2>
                        <p class="text-slate-400 font-bold text-[9px] uppercase tracking-[0.2em]">Classificazione Colore USDA (Munsell Chart)</p>
                    </div>
                    <div class="text-right">
                        <div id="gradeBig" class="bg-slate-900 text-amber-500 w-16 h-16 rounded-2xl flex flex-col items-center justify-center shadow-lg mx-auto">
                            <span class="text-[8px] font-black text-white uppercase">Grado</span>
                            <span class="text-3xl font-black leading-none">--</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 mb-8">
                    <div class="flex items-end gap-2"><span class="text-[10px] font-black text-slate-400 uppercase w-20">Fornitore:</span><span contenteditable="true" class="editable-field flex-1 text-sm italic">Inserisci...</span></div>
                    <div class="flex items-end gap-2"><span class="text-[10px] font-black text-slate-400 uppercase w-20">CU:</span><span contenteditable="true" class="editable-field flex-1 text-sm italic">Inserisci...</span></div>
                    <div class="flex items-end gap-2"><span class="text-[10px] font-black text-slate-400 uppercase w-20">Variet√†:</span><span contenteditable="true" class="editable-field flex-1 text-sm italic">Inserisci...</span></div>
                    <div class="flex items-end gap-2"><span class="text-[10px] font-black text-slate-400 uppercase w-20">Data/Ora:</span><span id="dateTimeField" class="font-bold text-slate-900 text-sm">--</span></div>
                </div>

                <div class="rounded-2xl overflow-hidden border border-slate-200 mb-6 bg-slate-50">
                    <img id="snapshotImg" class="w-full h-auto max-h-[350px] object-contain" />
                </div>

                <div id="miniChart" class="grid grid-cols-6 gap-2"></div>

                <div class="mt-8 pt-6 border-t border-slate-100 flex justify-between items-center">
                    <div id="statusField" class="text-[12px] font-black uppercase tracking-[0.1em] px-5 py-2 rounded-xl bg-slate-900 text-white shadow-inner">--</div>
                    <div class="no-print flex gap-2">
                        <button onclick="window.print()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-[10px] font-black uppercase">Screenshot/PDF</button>
                        <button onclick="location.reload()" class="px-4 py-2 bg-amber-500 text-slate-950 rounded-xl text-[10px] font-black uppercase">Reset</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const video = document.getElementById('videoFeed');
        const sCanvas = document.getElementById('sourceCanvas');
        const pCanvas = document.getElementById('processedCanvas');
        const captureBtn = document.getElementById('captureSnapshot');
        
        let isLive = false;
        let animId;

        const USDA_GRADES = [
            { id: "00", name: "00", desc: "Very Light", lab: [96, -2, 8], color: "#fefce8" },
            { id: "0", name: "0", desc: "Light", lab: [91, -4, 25], color: "#fef9c3" },
            { id: "1", name: "1", desc: "Light Brown", lab: [79, 4, 50], color: "#fde68a" },
            { id: "2", name: "2", desc: "Moderate Brown", lab: [64, 12, 55], color: "#f59e0b" },
            { id: "3", name: "3", desc: "Dark Brown", lab: [47, 18, 45], color: "#b45309" },
            { id: "4", name: "4", desc: "Very Dark", lab: [25, 15, 25], color: "#451a03" }
        ];

        function rgbToLab(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
            let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) * 100;
            let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) * 100;
            let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) * 100;
            x /= 95.047; y /= 100.000; z /= 108.883;
            x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x) + (16/116);
            y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y) + (16/116);
            z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z) + (16/116);
            return [(116 * y) - 16, 500 * (x - y), 200 * (y - z)];
        }

        function deltaE(l1, l2) { return Math.sqrt(Math.pow(l1[0]-l2[0],2) + Math.pow(l1[1]-l2[1],2) + Math.pow(l1[2]-l2[2],2)); }

        function analyze() {
            const sCtx = sCanvas.getContext('2d');
            const pCtx = pCanvas.getContext('2d');
            if(isLive) sCtx.drawImage(video, 0, 0, sCanvas.width, sCanvas.height);
            const imgData = sCtx.getImageData(0,0, sCanvas.width, sCanvas.height);
            const data = imgData.data;
            const output = pCtx.createImageData(sCanvas.width, sCanvas.height);
            const counts = { "00":0, "0":0, "1":0, "2":0, "3":0, "4":0 };
            let total = 0;

            for(let i=0; i<data.length; i+=4) {
                const r=data[i], g=data[i+1], b=data[i+2];
                if(r > 80 && r > b) {
                    const lab = rgbToLab(r,g,b);
                    let minD = 100, best = "0";
                    USDA_GRADES.forEach(gr => {
                        const de = deltaE(lab, gr.lab);
                        if(de < minD) { minD = de; best = gr.id; }
                    });
                    counts[best]++; total++;
                    output.data[i]=r; output.data[i+1]=g; output.data[i+2]=b; output.data[i+3]=255;
                } else {
                    output.data[i]=15; output.data[i+1]=23; output.data[i+2]=42; output.data[i+3]=255;
                }
            }
            pCtx.putImageData(output, 0, 0);
            if(isLive) animId = requestAnimationFrame(analyze);
            return { counts, total };
        }

        document.getElementById('startVideo').onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            video.classList.remove('hidden');
            sCanvas.classList.add('hidden');
            isLive = true;
            captureBtn.classList.remove('hidden');
            video.onloadedmetadata = () => {
                sCanvas.width = video.videoWidth/2; sCanvas.height = video.videoHeight/2;
                pCanvas.width = sCanvas.width; pCanvas.height = sCanvas.height;
                analyze();
            };
        };

        captureBtn.onclick = () => {
            isLive = false;
            cancelAnimationFrame(animId);
            const res = analyze();
            const oraEsatta = new Date().toLocaleString('it-IT', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
            document.getElementById('dateTimeField').innerText = oraEsatta;
            document.getElementById('finalReport').classList.remove('hidden');
            document.getElementById('snapshotImg').src = pCanvas.toDataURL();
            
            let domID = "1", maxP = -1;
            const miniChart = document.getElementById('miniChart');
            miniChart.innerHTML = '';

            USDA_GRADES.forEach(g => {
                const perc = res.total > 0 ? (res.counts[g.id]/res.total*100) : 0;
                if(perc > maxP) { maxP = perc; domID = g.id; }
                miniChart.innerHTML += `
                    <div class="text-center">
                        <div class="h-10 bg-slate-100 rounded-t flex items-end overflow-hidden border border-slate-200">
                            <div style="height:${perc}%; background-color:${g.color}; width:100%"></div>
                        </div>
                        <p class="text-[7px] font-black mt-1">G${g.name}</p>
                    </div>`;
            });

            const domGrade = USDA_GRADES.find(g => g.id === domID);
            document.getElementById('gradeBig').querySelector('span:last-child').innerText = domGrade.name;
            document.getElementById('statusField').innerText = "ESITO USDA: GRADO " + domGrade.name + " (" + domGrade.desc + ")";

            document.getElementById('finalReport').scrollIntoView({ behavior: 'smooth' });
        };
    </script>
</body>
</html>
