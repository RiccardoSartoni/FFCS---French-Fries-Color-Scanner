<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analizzatore Patate Fritte USDA - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Touch friendly optimizations */
        body {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .canvas-container {
            width: 100%;
            height: 220px; /* Ridotto per mobile per mostrare entrambi i canvas nello schermo */
            overflow: hidden;
            border-radius: 0.75rem;
            position: relative;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (min-width: 768px) {
            .canvas-container { height: 300px; }
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .pattern-dots {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 15px 15px;
        }
        .usda-sample {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .usda-sample.selected {
            border-color: #f59e0b;
            transform: scale(1.05);
            background-color: #fffbeb;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans p-3 md:p-6 flex flex-col">

    <div id="main-container" class="max-w-[1400px] mx-auto w-full flex-grow">
        <!-- Header con Branding Compatto per Mobile -->
        <header class="mb-4 flex flex-col sm:flex-row items-center justify-between bg-white p-4 rounded-2xl shadow-sm border border-slate-100 gap-4">
            <div class="flex items-center gap-3 w-full sm:w-auto">
                <div class="bg-amber-500 p-2.5 rounded-xl shadow-md">
                    <span class="text-xl">üçü</span>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-900 tracking-tighter leading-none uppercase">FRIES-SCAN <span class="text-amber-500 italic">Pro</span></h1>
                    <p class="text-slate-400 font-bold uppercase text-[7px] tracking-[0.2em] mt-1">ANALISI COLORE REAL-TIME</p>
                </div>
            </div>

            <!-- Branding PIZZOLI spa -->
            <div class="flex items-center justify-end gap-3 bg-slate-50 px-4 py-2.5 rounded-xl border border-slate-100 w-full sm:w-auto">
                <div class="text-right">
                    <p class="text-black font-black text-[11px] uppercase tracking-wider leading-none">PIZZOLI spa</p>
                    <p class="text-slate-500 font-bold text-[9px] leading-none mt-1">R&D AGRO Technology</p>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            
            <!-- Colonna Sinistra: Caricamento e Verdetto -->
            <div class="lg:col-span-3 flex flex-col gap-4 order-1">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <label for="imageUpload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-100 border-dashed rounded-xl cursor-pointer bg-slate-50 active:bg-amber-50 hover:bg-amber-50 transition-all group">
                        <div class="flex flex-col items-center justify-center text-slate-400">
                            <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <p class="text-[11px] font-black uppercase tracking-widest">FOTO O CARICA</p>
                        </div>
                        <input id="imageUpload" type="file" class="hidden" accept="image/*" capture="environment" />
                    </label>

                    <div id="controls" class="hidden mt-4">
                        <button id="processBtn" class="w-full py-4 bg-slate-900 active:bg-black text-white text-[11px] font-black uppercase rounded-xl transition-all shadow-md">
                            Rielabora Analisi
                        </button>
                    </div>
                </div>

                <!-- Card del Verdetto -->
                <div id="finalGradeCard" class="hidden bg-slate-900 p-5 rounded-2xl shadow-lg text-center border-b-4 border-amber-500">
                    <h3 class="text-[8px] font-black uppercase tracking-widest text-slate-500 mb-2">Classificazione USDA</h3>
                    <div id="gradeBadge" class="inline-block px-5 py-2.5 rounded-xl bg-amber-500 text-slate-950 font-black text-3xl mb-2">--</div>
                    <p id="gradeDescription" class="text-[11px] text-slate-300 leading-tight italic uppercase font-bold tracking-tight">In attesa...</p>
                </div>
            </div>

            <!-- Centro: Area Visuale -->
            <div class="lg:col-span-6 flex flex-col gap-4 order-2">
                <div class="bg-white p-3 md:p-4 rounded-2xl shadow-sm border border-slate-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="space-y-1.5">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest pl-1">Sorgente Originale</span>
                            <div class="canvas-container"><canvas id="sourceCanvas"></canvas></div>
                        </div>
                        <div class="space-y-1.5">
                            <span class="text-[9px] font-black text-amber-500 uppercase tracking-widest pl-1">Mappatura Digitale</span>
                            <div class="canvas-container pattern-dots !bg-slate-950"><canvas id="processedCanvas"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 overflow-x-auto">
                    <h2 class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-3 text-center">Standard di Riferimento USDA</h2>
                    <div id="usdaScaleContainer" class="flex md:grid md:grid-cols-6 gap-2 min-w-max md:min-w-0"></div>
                </div>
            </div>

            <!-- Sidebar Destra: Dettagli Analisi -->
            <div class="lg:col-span-3 order-3">
                <div id="resultsCard" class="hidden bg-white p-5 rounded-2xl shadow-sm border border-slate-100 h-fit">
                    <h3 class="font-black text-[10px] uppercase tracking-widest text-slate-400 border-b pb-3 mb-4 text-center">Distribuzione %</h3>
                    
                    <div id="chartContainer" class="space-y-5"></div>
                    
                    <div class="mt-6 pt-4 border-t border-slate-50 bg-slate-50/50 p-3 rounded-xl">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] font-black text-slate-500 uppercase">Pixel Analizzati</span>
                            <span id="totalPixels" class="text-slate-900 font-mono text-[10px] font-bold bg-white px-2 py-0.5 rounded border border-slate-100">0 px</span>
                        </div>
                        <p class="text-[8px] text-slate-400 italic leading-tight mt-2 text-center">Analisi basata sulla massa pixel filtrata.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer con Copyright -->
    <footer class="mt-8 mb-4 text-center">
        <p class="text-[9px] text-slate-400 font-medium uppercase tracking-[0.2em]">
            Copyright Riccardo Sartoni
        </p>
    </footer>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const sourceCanvas = document.getElementById('sourceCanvas');
        const processedCanvas = document.getElementById('processedCanvas');
        const processBtn = document.getElementById('processBtn');
        const chartContainer = document.getElementById('chartContainer');
        const gradeBadge = document.getElementById('gradeBadge');
        const gradeDescription = document.getElementById('gradeDescription');
        const totalPixelsLabel = document.getElementById('totalPixels');

        let originalImage = null;

        const DEFAULT_HUE_THRESHOLD = 35;
        const DEFAULT_SAT_THRESHOLD = 15;

        const USDA_GRADES = [
            { id: "00", name: "00", rgb: [245, 245, 230], color: "#f5f5e6" },
            { id: "0", name: "0", rgb: [240, 230, 180], color: "#f0e6b4" },
            { id: "1", name: "1", rgb: [225, 190, 100], color: "#e1be64" },
            { id: "2", name: "2", rgb: [200, 150, 60], color: "#c8963c" },
            { id: "3", name: "3", rgb: [160, 100, 40], color: "#a06428" },
            { id: "4", name: "4", rgb: [90, 50, 20], color: "#5a3214" }
        ];

        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            const d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) h = 0;
            else {
                if (max === r) h = (g - b) / d + (g < b ? 6 : 0);
                else if (max === g) h = (b - r) / d + 2;
                else h = (r - g) / d + 4;
                h /= 6;
            }
            return [h * 360, s * 100, v * 100];
        }

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                originalImage = new Image();
                originalImage.onload = () => {
                    initCanvases();
                    processImage();
                    document.getElementById('controls').classList.remove('hidden');
                    document.getElementById('resultsCard').classList.remove('hidden');
                    document.getElementById('finalGradeCard').classList.remove('hidden');
                    if (window.innerWidth < 768) {
                        document.getElementById('finalGradeCard').scrollIntoView({ behavior: 'smooth' });
                    }
                };
                originalImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function initCanvases() {
            const maxDimension = window.innerWidth < 768 ? 800 : 1200;
            const scale = Math.min(1, maxDimension / Math.max(originalImage.width, originalImage.height));
            sourceCanvas.width = originalImage.width * scale;
            sourceCanvas.height = originalImage.height * scale;
            processedCanvas.width = sourceCanvas.width;
            processedCanvas.height = sourceCanvas.height;
            sourceCanvas.getContext('2d', { willReadFrequently: true }).drawImage(originalImage, 0, 0, sourceCanvas.width, sourceCanvas.height);
        }

        function processImage() {
            if (!originalImage) return;
            const sCtx = sourceCanvas.getContext('2d', { willReadFrequently: true });
            const pCtx = processedCanvas.getContext('2d');
            const imageData = sCtx.getImageData(0, 0, sourceCanvas.width, sourceCanvas.height);
            const data = imageData.data;
            const pData = pCtx.createImageData(sourceCanvas.width, sourceCanvas.height);
            
            let totalFound = 0;
            const counts = { "00": 0, "0": 0, "1": 0, "2": 0, "3": 0, "4": 0 };

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const [h, s, v] = rgbToHsv(r, g, b);
                
                if (Math.abs(h - 45) < DEFAULT_HUE_THRESHOLD && s > DEFAULT_SAT_THRESHOLD && v > 20) {
                    pData.data[i] = r; pData.data[i+1] = g; pData.data[i+2] = b; pData.data[i+3] = 255;
                    totalFound++;
                    let minD = Infinity, best = "0";
                    USDA_GRADES.forEach(gr => {
                        const d = Math.sqrt((r-gr.rgb[0])**2 + (g-gr.rgb[1])**2 + (b-gr.rgb[2])**2);
                        if (d < minD) { minD = d; best = gr.id; }
                    });
                    counts[best]++;
                } else {
                    pData.data[i] = 15; pData.data[i+1] = 15; pData.data[i+2] = 20; pData.data[i+3] = 255;
                }
            }
            pCtx.putImageData(pData, 0, 0);
            updateUI(counts, totalFound);
        }

        function updateUI(counts, total) {
            chartContainer.innerHTML = '';
            totalPixelsLabel.innerText = total.toLocaleString() + ' px';
            
            let dominant = "1", maxP = -1;
            
            USDA_GRADES.forEach(grade => {
                const p = total > 0 ? (counts[grade.id] / total * 100) : 0;
                if (p > maxP) { maxP = p; dominant = grade.id; }
                
                chartContainer.innerHTML += `
                    <div class="space-y-1.5">
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] font-black text-slate-700 uppercase leading-none">USDA ${grade.name}</span>
                            <div class="flex items-baseline gap-1">
                                <span class="text-xs font-black text-slate-900 font-mono">${p.toFixed(1)}</span>
                                <span class="text-[8px] font-bold text-slate-400">%</span>
                            </div>
                        </div>
                        <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden flex border border-slate-50 shadow-inner">
                            <div class="h-full transition-all duration-700 ease-out relative group" style="width:${p}%; background:${grade.color}">
                                <div class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            </div>
                        </div>
                    </div>`;
            });

            document.querySelectorAll('.usda-sample').forEach(el => el.classList.remove('selected'));
            const selectedSample = document.getElementById(`sample-${dominant}`);
            if (selectedSample) selectedSample.classList.add('selected');

            gradeBadge.innerText = `USDA ${dominant}`;
            gradeDescription.innerText = dominant < 1 ? "Cottura Insufficiente" : (dominant < 3 ? "Qualit√† Ottimale" : "Cottura Eccessiva");
        }

        processBtn.onclick = processImage;

        document.getElementById('usdaScaleContainer').innerHTML = USDA_GRADES.map(g => `
            <div id="sample-${g.id}" class="usda-sample p-2.5 bg-white border border-slate-100 rounded-xl flex flex-col items-center min-w-[70px]">
                <div class="w-full aspect-square rounded-lg mb-1 shadow-sm border border-slate-200" style="background:${g.color}"></div>
                <span class="text-[9px] font-black text-slate-500 uppercase">G${g.name}</span>
            </div>
        `).join('');
    </script>
</body>
</html>
